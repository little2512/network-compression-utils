name: Auto Version Bump

on:
  push:
    branches:
      - main
  # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

jobs:
  auto-version:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        # èŽ·å–å®Œæ•´åŽ†å²è®°å½•ï¼Œç”¨äºŽæäº¤ä¿¡æ¯åˆ†æž
        fetch-depth: 0
        # ä½¿ç”¨tokenä»¥ä¾¿æŽ¨é€åˆ°ä»“åº“
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Get current version
      id: version
      run: |
        CURRENT_VERSION=$(npm pkg get version | tr -d '"')
        echo "current_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
        echo "Current version: $CURRENT_VERSION"

    - name: Check if version bump is needed
      id: check
      run: |
        # èŽ·å–æœ€æ–°çš„æäº¤ä¿¡æ¯
        LATEST_COMMIT=$(git log -1 --pretty=format:"%s")
        echo "Latest commit: $LATEST_COMMIT"

        # æ£€æŸ¥æ˜¯å¦åŒ…å«ç‰ˆæœ¬å‡çº§ç›¸å…³çš„å…³é”®è¯
        if [[ "$LATEST_COMMIT" =~ (bump|version|release|v[0-9]+\.[0-9]+\.[0-9]+) ]]; then
          echo "Version bump already detected in commit, skipping"
          echo "should_bump=false" >> $GITHUB_OUTPUT
        else
          echo "should_bump=true" >> $GITHUB_OUTPUT
        fi

    - name: Determine version bump type
      id: bump_type
      if: steps.check.outputs.should_bump == 'true'
      run: |
        # èŽ·å–æœ€æ–°çš„æäº¤ä¿¡æ¯
        LATEST_COMMIT=$(git log -1 --pretty=format:"%s")
        echo "Analyzing commit: $LATEST_COMMIT"

        # æ ¹æ®æäº¤ä¿¡æ¯å†³å®šç‰ˆæœ¬å‡çº§ç±»åž‹
        if [[ "$LATEST_COMMIT" =~ (fix|bug|patch|hotfix) ]]; then
          BUMP_TYPE="patch"
        elif [[ "$LATEST_COMMIT" =~ (feat|feature|add|new) ]]; then
          BUMP_TYPE="minor"
        elif [[ "$LATEST_COMMIT" =~ (breaking|major|rewrite) ]]; then
          BUMP_TYPE="major"
        else
          # é»˜è®¤ä¸ºpatchç‰ˆæœ¬
          BUMP_TYPE="patch"
        fi

        echo "bump_type=$BUMP_TYPE" >> $GITHUB_OUTPUT
        echo "Version bump type: $BUMP_TYPE"

    - name: Configure Git
      if: steps.check.outputs.should_bump == 'true'
      run: |
        # é…ç½®Gitç”¨æˆ·ä¿¡æ¯
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"

    - name: Bump version
      if: steps.check.outputs.should_bump == 'true'
      run: |
        # æ‰§è¡Œç‰ˆæœ¬å‡çº§
        BUMP_TYPE="${{ steps.bump_type.outputs.bump_type }}"
        echo "Bumping version with type: $BUMP_TYPE"

        # ä½¿ç”¨npm versionå‡çº§ç‰ˆæœ¬
        npm version $BUMP_TYPE -m "ðŸ”– Auto version bump to %s [skip ci]"

        # èŽ·å–æ–°ç‰ˆæœ¬å·
        NEW_VERSION=$(npm pkg get version | tr -d '"')
        echo "New version: $NEW_VERSION"
        echo "new_version=$NEW_VERSION" >> $GITHUB_ENV

    - name: Push new version
      if: steps.check.outputs.should_bump == 'true'
      run: |
        # æŽ¨é€æ–°ç‰ˆæœ¬å’Œæ ‡ç­¾
        git push origin main --follow-tags

        echo "Version ${{ env.new_version }} pushed successfully"

    - name: Create Release
      if: steps.check.outputs.should_bump == 'true'
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: v${{ env.new_version }}
        release_name: v${{ env.new_version }}
        draft: false
        prerelease: false
        body: |
          ## Version ${{ env.new_version }}

          This is an automatic version bump.

          ðŸ“ **Changes**: See commit history for detailed changes

          ðŸš€ **Installation**:
          ```bash
          npm install network-compression-utils@${{ env.new_version }}
          ```

          ðŸ“¦ **Download**:
          - [npm package](https://www.npmjs.com/package/network-compression-utils/v/${{ env.new_version }})
          - [GitHub Release](https://github.com/little2512/network-compression-utils/releases/tag/v${{ env.new_version }})

    - name: Summary
      if: steps.check.outputs.should_bump == 'true'
      run: |
        echo "## âœ… Version Auto-Bump Complete" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Previous Version**: ${{ steps.version.outputs.current_version }}" >> $GITHUB_STEP_SUMMARY
        echo "- **New Version**: ${{ env.new_version }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Bump Type**: ${{ steps.bump_type.outputs.bump_type }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Release Created**: âœ…" >> $GITHUB_STEP_SUMMARY
        echo "- **Package Published**: âœ… (via publish workflow)" >> $GITHUB_STEP_SUMMARY

    - name: Skip Summary
      if: steps.check.outputs.should_bump == 'false'
      run: |
        echo "## â­ï¸ Version Bump Skipped" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Reason**: Version bump detected in latest commit" >> $GITHUB_STEP_SUMMARY
        echo "- **Current Version**: ${{ steps.version.outputs.current_version }}" >> $GITHUB_STEP_SUMMARY